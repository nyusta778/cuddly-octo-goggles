name: "‚ö° EnigMano ‚Äî GCRD Automation (Modified)"

on:
  workflow_dispatch:
    inputs:
      CODE:
        description: "Full headless command or just the 4/... token from https://remotedesktop.google.com/headless (Windows)."
        required: true
      PIN:
        description: "CRD PIN (6+ digits). Default 123456"
        required: false
        default: "123456"
      RETRIES:
        description: "Retries for start-host (default 3)"
        required: false
        default: "3"

permissions:
  contents: read

concurrency:
  group: crd-register-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  crd-register:
    name: "ü™Ñ EnigMano Windows 10"
    runs-on: windows-2022

    env:
      RAW_CODE:      ${{ github.event.inputs.CODE }}
      PIN_INPUT:     ${{ github.event.inputs.PIN }}
      RETRIES_INPUT: ${{ github.event.inputs.RETRIES }}
      BRANCH:        ${{ github.ref_name }}
      RUNNER_ENV:    "hosted"

    defaults:
      run:
        shell: pwsh

    steps:
      - name: "üîß Environment Summary (with quiet preload)"
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          Write-Host "==============================================="
          Write-Host "üíª OS Version        : $env:ImageOS"
          Write-Host "üß† Runner Machine    : $env:RUNNER_NAME"
          Write-Host "üè∑Ô∏è Repository        : $env:GITHUB_REPOSITORY"
          Write-Host "üåø Branch/Ref        : $env:BRANCH"
          Write-Host "üîÅ Workflow Run ID   : $env:GITHUB_RUN_ID"
          Write-Host "==============================================="

          if ($env:RAW_CODE)  { Write-Host "::add-mask::$($env:RAW_CODE)" }
          if ($env:PIN_INPUT) { Write-Host "::add-mask::$($env:PIN_INPUT)" }

          try {
            $userDownloads = Join-Path $env:USERPROFILE 'Downloads'
            if (-not (Test-Path $userDownloads)) { New-Item -ItemType Directory -Path $userDownloads | Out-Null }

            $retries = 3
            if ($env:RETRIES_INPUT) { try { $retries = [int]$env:RETRIES_INPUT } catch {} }
            $dlAttempts = [Math]::Max(3, $retries)

            $assets = @(
              @{ Url = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"; Name = "crdhost.msi" },
              @{ Url = "https://downloads.cloudflareclient.com/v1/download/windows/ga"; Name = "Cloudflare_WARP_x64.msi" },
              @{ Url = "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack45.zip"; Name = "VBCABLE.zip" },
              @{ Url = "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64-user"; Name = "VisualStudio.exe" },
              @{ Url = "https://nodejs.org/dist/v24.11.0/node-v24.11.0-x64.msi"; Name = "node-v24.msi" }
            )

            function Download-Quiet([string]$Url,[string]$OutFile,[int]$Attempts) {
              for ($i=1; $i -le $Attempts; $i++) {
                try {
                  Invoke-WebRequest -Uri $Url -OutFile $OutFile -UseBasicParsing -TimeoutSec 120
                  if ((Test-Path -LiteralPath $OutFile) -and ((Get-Item $OutFile).Length -gt 0)) { return }
                  throw "Downloaded file missing or zero-size."
                } catch {
                  if ($i -eq $Attempts) { throw }
                  Start-Sleep -Seconds ([int][Math]::Min(20, ($i * 2)))
                }
              }
            }

            foreach ($a in $assets) {
              $dest = Join-Path $userDownloads $a.Name
              Download-Quiet -Url $a.Url -OutFile $dest -Attempts $dlAttempts
            }

            Write-Host "üìÅ Save location: $userDownloads"
          } catch {
            Write-Error "‚ùå Preload failed: $($_.Exception.Message)"
          }

      - name: "üåü EnigMano Magical Setup & Execution"
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          # ============================================================
          # ENIGMANO: WINDOWS 10 FORTRESS DEPLOYMENT PROTOCOL
          # ============================================================

          function Timestamp { (Get-Date).ToString("yyyy-MM-dd HH:mm:ss") }
          function Log($msg)  { Write-Host "[ENIGMANO $(Timestamp)] $msg" }
          function Fail($msg) { Write-Error "[ENIGMANO-ERROR $(Timestamp)] $msg"; Exit 1 }

          $now = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          Write-Host @"
          ------------------------------------------------------------
                          ENIGMANO // FORTRESS ONLINE
          ------------------------------------------------------------
            STATUS    : Deployment matrix initializing
            TIME      : $now
            ARCHITECT : https://www.youtube.com/@ShahzaibYT-itxsb
            PROFILE   : Windows 10 Tactical Workstation (Sound-Enabled)
            DOCTRINE  : Precision - Containment - Auditability
          ------------------------------------------------------------
          "@

          $RUNNER_ENV     = $env:RUNNER_ENV
          $RAW_CODE       = $env:RAW_CODE
          $PIN_INPUT      = $env:PIN_INPUT
          $RETRIES_INPUT  = $env:RETRIES_INPUT

          # ============================================================
          # PRIMARY DEPLOYMENT: SYSTEM FORGE
          # ============================================================

          try {
              Log "Node LTS (~45s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/Node-LTS.ps1" -OutFile Node-LTS.ps1
              .\Node-LTS.ps1
              Log "Node LTS - Forge completed successfully."
          } catch { Fail "Node LTS - Forge sequence failure. $_" }

          try {
              Log "Visual Studio Code (~45s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/Visual-Code.ps1" -OutFile Visual-Code.ps1
              .\Visual-Code.ps1
              Log "Visual Studio Code - Operator Core installed and aligned."
          } catch { Fail "Visual Studio Code - Core installation failure. $_" }

          try {
              Log "Phase Persona - Engaging Environment Protocols (~15s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/Env-Personalization.ps1" -OutFile Env-Personalization.ps1
              .\Env-Personalization.ps1
              Log "Phase Persona - Visual and ergonomic hardening complete."
          } catch { Fail "Phase Persona - Execution failure. $_" }

          try {
              Log "Phase Browser-Core - Manifesting Brave Shell (~40s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/Brave-Browser.ps1" -OutFile Brave-Browser.ps1
              .\Brave-Browser.ps1
              Log "Phase Browser-Core - Brave aligned and operational."
          } catch { Fail "Phase Browser-Core - Operation failure. $_" }

          try {
              Log "Phase Browser-Extensions - Injecting augmentation suite (~25s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/Browser-Extensions.ps1" -OutFile Browser-Extensions.ps1
              .\Browser-Extensions.ps1
              Log "Phase Browser-Extensions - Augmentation sequence complete."
          } catch { Fail "Phase Browser-Extensions - Failure detected. $_" }

          try {
              Log "Phase Browser-Env - Establishing runtime matrix (~55s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/Browser-Env-Setup.ps1" -OutFile Browser-Env-Setup.ps1
              .\Browser-Env-Setup.ps1
              Log "Phase Browser-Env - Runtime context stabilized."
          } catch { Fail "Phase Browser-Env - Failure encountered. $_" }

          try {
              Log "Phase Audio - Assembling virtual drivers (~120s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/VB-Audio.ps1" -OutFile VB-Audio.ps1
              .\VB-Audio.ps1
              Log "Phase Audio - Sound layer secured and synchronized."
          } catch { Fail "Phase Audio - Driver deployment failure. $_" }

          try {
              Log "Phase GCRD - Preflight initiation (~120s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/GCRD-setup.ps1" -OutFile GCRD-setup.ps1
              .\GCRD-setup.ps1
              Log "Phase GCRD - Remote command channel established."
          } catch { Fail "Phase GCRD - Setup failure. $_" }

          try {
              $desktopPath = [Environment]::GetFolderPath("Desktop")
              $dataFolderPath = Join-Path $desktopPath "Data"
              if (-not (Test-Path $dataFolderPath)) {
                  New-Item -Path $dataFolderPath -ItemType Directory | Out-Null
                  Log "Vault - Created tactical data sanctuary at $dataFolderPath"
              } else {
                  Log "Vault - Existing artifact chamber detected."
              }
          } catch { Fail "Vault - Creation anomaly. $_" }

          try {
              Log "Phase WARP - Engaging edge routing client (~60s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/Cloudflare-WARP.ps1" -OutFile Cloudflare-WARP.ps1
              .\Cloudflare-WARP.ps1
              Log "Phase WARP - Edge layer operational."
          } catch { Fail "Phase WARP - Edge client failure. $_" }

          try {
              Log "Phase IDM (~20s)"
              Invoke-WebRequest "https://gitlab.com/Shahzaib-YT/enigmano-win10-gcrd-instance/-/raw/main/Download_Manager.ps1" -OutFile Download_Manager.ps1
              .\Download_Manager.ps1
              Log "Phase IDM - ready."
          } catch { Fail "Phase IDM - Installation failure. $_" }

          $totalMinutes = 335
          $startTime    = Get-Date
          $endTime      = $startTime.AddMinutes($totalMinutes)

          function ClampMinutes([TimeSpan]$ts) {
              $mins = [math]::Round($ts.TotalMinutes, 1)
              if ($mins -lt 0) { return 0 }
              return $mins
          }

          while ((Get-Date) -lt $endTime) {
              $now       = Get-Date
              $elapsed   = [math]::Round(($now - $startTime).TotalMinutes, 1)
              $remaining = ClampMinutes ($endTime - $now)
              Log "Window - Operational Uptime ${elapsed}m | Remaining ${remaining}m"
              Start-Sleep -Seconds ((Get-Random -Minimum 300 -Maximum 800))
          }

          Log "Window - Mission duration ${totalMinutes}m achieved. Preparing for decommission."
          Log "Decommission - Initiating final shutdown protocol."

          if ($RUNNER_ENV -eq "self-hosted") {
              Stop-Computer -Force
          } else {
              Log "Decommission - Hosted environment detected. Exiting gracefully."
              Exit
          }
